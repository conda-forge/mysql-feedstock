From 36e750fd8cd2c8eef70e1118525f23a271c1e8dc Mon Sep 17 00:00:00 2001
From: Nehal J Wani <nehaljw.kkd1@gmail.com>
Date: Sun, 24 Oct 2021 15:21:38 -0400
Subject: [PATCH 17/17] Add workaround for a bug in GCC v9.4.0 (aarch64)

xref: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=100985
---
 include/my_checksum.h        | 6 ++++++
 storage/innobase/ut/crc32.cc | 6 ++++++
 2 files changed, 12 insertions(+)

diff --git a/include/my_checksum.h b/include/my_checksum.h
index b9919d3679c..f2011ac5067 100644
--- a/include/my_checksum.h
+++ b/include/my_checksum.h
@@ -41,6 +41,12 @@
 
 #ifdef HAVE_ARMV8_CRC32_INTRINSIC
 #include <arm_acle.h>   // __crc32x
+#if defined(__aarch64__) && defined(__GNUC__)
+#if __GNUC__ == 9 && __GNUC_MINOR__ == 4 && __GNUC_PATCHLEVEL__ == 0
+}
+#endif
+#endif
+
 #ifndef APPLE_ARM
 #include <asm/hwcap.h>  // HWCAP_CRC32
 #include <sys/auxv.h>   // getauxval
diff --git a/storage/innobase/ut/crc32.cc b/storage/innobase/ut/crc32.cc
index 73f79427895..da4e019bae2 100644
--- a/storage/innobase/ut/crc32.cc
+++ b/storage/innobase/ut/crc32.cc
@@ -107,7 +107,13 @@ external tools. */
 
 #ifdef CRC32_ARM64
 #include <arm_acle.h>
+#if defined(__aarch64__) && defined(__GNUC__)
+#if __GNUC__ == 9 && __GNUC_MINOR__ == 4 && __GNUC_PATCHLEVEL__ == 0
+}
+#endif
+#endif
 #include <arm_neon.h>
+
 #endif /* CRC32_ARM64 */
 
 #ifdef CRC32_ARM64_DEFAULT
-- 
2.33.1

